<html xmlns:th="http://www.thymeleaf.org">
<div th:fragment="template (videoList)">
    <div class="videoPreviewBlock" th:each="video : ${videoList}">
        <p th:text="${video.name}" style="height: 20px">Video Stream ID</p>
        <div class="videoBlock" th:include=":: videoBlock (${video.id})"></div>
        <a class="calibration-required-notice"
           th:if="${video.calibrationPointList.isEmpty()}"
           th:text="#{video.preview.calibration.required}"
           th:href="'/video/' + ${video.id} + '/calibration/'">
        </a>
    </div>
    <form action="/video/add" method="get">
        <button id="addVideoButton" type="submit">+</button>
    </form>
    <div th:include=":: playVideoScript (${videoList})"></div>
</div>

<div th:fragment="videoBlock (videoId)">
    <video th:id="'video' + ${videoId}" class="video" muted="muted" autoplay="autoplay"></video>
</div>

<div th:fragment="drawableVideoBlock (videoId)">
    <video th:id="'video' + ${videoId}" class="video" muted="muted" autoplay="autoplay"></video>
    <canvas class="draw-over-video-canvas"></canvas>
</div>

<div th:fragment="playVideoScript (vidoeList)">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const cfg = Hls.DefaultConfig

        cfg["initialLiveManifestSize"] = 2
        cfg["backBufferLength"] = 0
        cfg["maxBufferHole"] = 0.0
        cfg["maxMaxBufferLength"] = 300
        cfg["maxMaxBufferLength"] = 180
        cfg["liveSyncDurationCount"] = 0
        cfg["liveDurationInfinity"] = true

        if (Hls.isSupported()) {
            const videoIds = [[${videoList}]].map((video) => video.id)

            videoIds.forEach(videoId => {
                let video = document.getElementById('video' + videoId);
                let hls = new Hls();

                hls.attachMedia(video);
                hls.loadSource("/api/v1/video/" + videoId + "/manifest");
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.play();
                });
            })
        }
        /*]]>*/
    </script>
</div>